<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CTP Page Monitor - Mobile Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --color-bg-primary: #0f0f12;
      --color-bg-secondary: #1a1a1f;
      --color-bg-card: #25252d;
      --color-text-light: #e0e0e0;
      --color-text-dim: #a0a0a0;
      --color-accent-blue: #0077b6;
      --color-accent-cyan: #00b4d8;
      --color-accent-yellow: #ffb703;
      --color-accent-red: #e63946;
      --color-accent-green: #3c9f3c;
      --color-issue-text: #66cc66;
      --color-edition-title-bg: #0077b6;
      --color-section-title-bg: #33333d;
      --color-status-ok: #2a9d8f;
      --color-status-fail: #e76f51;
      --color-section-title: #f8f9fa;
      --color-border: #33333d;
      --border-radius: 3px;
      --spacing-unit: 6px;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--color-bg-primary);
      color: var(--color-text-light);
      padding: var(--spacing-unit);
      font-size: 0.833em;
      line-height: 1.3;
    }

    .header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--color-bg-secondary);
      padding: var(--spacing-unit);
      border-radius: var(--border-radius);
      margin-bottom: var(--spacing-unit);
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
    }
    
    .title {
      color: var(--color-accent-yellow);
      font-weight: normal;
      font-size: 1.3em;
    }
    
    .nav-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .nav-btn {
      background: var(--color-accent-blue);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.95em;
    }
    
    .nav-btn:disabled {
      background: var(--color-bg-card);
      color: var(--color-text-dim);
      cursor: not-allowed;
    }
    
    .current-date {
      font-weight: bold;
      color: var(--color-accent-yellow);
      min-width: 80px;
      text-align: center;
    }

    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--spacing-unit);
    }

    .card {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      padding: 0;
      overflow: hidden;
    }

    .card h3 {
      margin: 0;
      padding: 6px 8px;
      background: var(--color-edition-title-bg);
      color: white;
      font-weight: normal;
      font-size: 1.05em;
      text-transform: uppercase;
    }

    .checklist-table {
      width: 100%;
      font-size: 0.9em;
      border-collapse: collapse;
    }
    
    .checklist-table td {
      padding: 3px;
      border-bottom: 1px solid #2f2f38;
    }
    
    .checklist-table tr:last-child td { 
      border-bottom: none; 
    }

    .filename-col {
      width: 15%;
      white-space: nowrap;
    }
    
    .title-col {
      width: 43%;
    }
    
    .edit-col, .icd-col { 
      width: 7%; 
      text-align: center; 
    }
    
    .status-col { 
      width: 3%; 
      text-align: center; 
    }
    
    .time-col { 
      width: 25%; 
      text-align: right; 
      color: var(--color-text-dim); 
    }

    .issue-group-title-row td, .pullout-group-title-row td {
      padding: 4px 8px !important;
      font-weight: normal;
      font-size: 1em;
      color: var(--color-section-title);
      background: var(--color-section-title-bg);
      border-bottom: 1px solid var(--color-border) !important;
      column-span: 6;
    }
    
    .pullout-group-title-row td {
      color: #c0c0ff;
      background: #3d3345;
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .status-ok { 
      background-color: var(--color-status-ok); 
    }
    
    .status-fail { 
      background-color: var(--color-status-fail); 
    }

    .error {
      background: #3d0000;
      color: #ffcccc;
      padding: 6px 8px;
      border-radius: 3px;
      border-left: 4px solid var(--color-accent-red);
      margin-bottom: 6px;
      font-size: 0.95em;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: var(--color-text-dim);
    }
  </style>
</head>
<body>
  <div class="header-bar">
    <div class="title">CTP Page Monitor</div>
    <div class="nav-controls">
  <!-- Left arrow button on left -->
  <button id="prev-date-btn" class="nav-btn" disabled>←</button>
  <div id="current-date" class="current-date">Loading...</div>
  <!-- Right arrow button on right -->
  <button id="next-date-btn" class="nav-btn" disabled>→</button>
</div>
  </div>

  <div id="errorContainer"></div>
  <div id="loadingMessage" class="loading">Loading data...</div>
  <div class="container" id="cards"></div>

  <script>
    // Configuration - Hardcoded GAS URL
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzQ8-Wgdg44ogQfKAoZSEoDQMaXRc7KT6EG4x1UFRk5RhcHp-ergUwtIQEnrUREItgV/exec";
    let availableDates = [];
    let currentDateIndex = -1;
    let currentDatePrefix = '';

    // DOM Elements
    const prevDateBtn = document.getElementById('prev-date-btn');
    const nextDateBtn = document.getElementById('next-date-btn');
    const currentDateEl = document.getElementById('current-date');
    const errorContainer = document.getElementById('errorContainer');
    const loadingMessage = document.getElementById('loadingMessage');
    const cardsContainer = document.getElementById('cards');

    // Format date for display
    function formatDisplayDate(dateStr) {
      if (!dateStr || dateStr.length !== 8) return 'N/A';
      return `${dateStr.substring(0, 2)}/${dateStr.substring(2, 4)}/${dateStr.substring(4, 8)}`;
    }

    // Show error message
    function showError(msg) {
      errorContainer.innerHTML = `<div class="error">${msg}</div>`;
      console.warn(msg);
    }

    // Clear error message
    function clearError() {
      errorContainer.innerHTML = '';
    }

    // Show loading state
    function showLoading(message) {
      loadingMessage.textContent = message;
      loadingMessage.style.display = 'block';
      cardsContainer.innerHTML = '';
    }

    // Hide loading state
    function hideLoading() {
      loadingMessage.style.display = 'none';
    }

    // Fetch default date from Google Sheets Settings
    async function fetchDefaultDate() {
      try {
        const url = `${GAS_URL}?action=getDefaultDate`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        
        const json = await res.json();
        if (json.status === 'success' && json.default_date) {
          return json.default_date;
        }
        throw new Error('Invalid default date response');
      } catch (err) {
        console.error('Failed to fetch default date:', err);
        // Fallback to today's date
        const today = new Date();
        return String(today.getDate()).padStart(2, '0') + 
               String(today.getMonth() + 1).padStart(2, '0') + 
               today.getFullYear();
      }
    }

    // Fetch available dates from Google Apps Script
    async function fetchAvailableDates() {
      try {
        const url = `${GAS_URL}?action=listDates`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        
        const json = await res.json();
        if (json.status === 'success' && Array.isArray(json.dates)) {
          return json.dates;
        } else {
          throw new Error(json.message || 'Invalid response format');
        }
      } catch (err) {
        console.error('Failed to fetch dates:', err);
        throw new Error(`Failed to load dates: ${err.message}`);
      }
    }

    // Load snapshot data for a specific date
    async function loadSnapshotForDate(datePrefix) {
      try {
        const url = `${GAS_URL}?action=getSnapshot&date=${datePrefix}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        
        const json = await res.json();
        if (json.status === 'success') {
          // Return both the snapshot data AND the date from column A
          return {
            snapshot: JSON.parse(json.page_log_json),
            datePrefix: json.date_prefix // This comes from column A
          };
        } else if (json.status === 'not_found') {
          throw new Error('No snapshot found for this date');
        } else {
          throw new Error(json.message || 'Invalid snapshot data');
        }
      } catch (err) {
        console.error('Failed to load snapshot:', err);
        throw new Error(`Failed to load snapshot: ${err.message}`);
      }
    }

    // Render status cards from snapshot data
    function renderStatusCards(snapshotData) {
      cardsContainer.innerHTML = '';

      if (!snapshotData || !snapshotData.snapshot || !snapshotData.snapshot.status) {
        cardsContainer.innerHTML = '<div class="error">No data available for this date</div>';
        return;
      }

      const { snapshot, datePrefix } = snapshotData;

      // Update current date display with the date from column A
      currentDatePrefix = datePrefix;
      currentDateEl.textContent = formatDisplayDate(datePrefix);

      // Helper function to convert the full filename to abbreviated version
      function getAbbreviatedFilename(fullFileName) {
        const parts = fullFileName.split('-');
        if (parts.length >= 2) {
          let suffix = parts.slice(-2).join('-');
          if (suffix.endsWith('.pdf')) suffix = suffix.slice(0, -4);
          return suffix;
        }
        return fullFileName;
      }

      // Render each edition
      for (const editionKey in snapshot.status) {
        const card = document.createElement('div');
        card.className = 'card';

        const title = document.createElement('h3');
        title.textContent = editionKey;
        card.appendChild(title);

        const table = document.createElement('table');
        table.className = 'checklist-table';
        const rows = snapshot.status[editionKey];

        rows.forEach(item => {
          // Group titles (e.g., "Main Issue", "Pullout")
          if (item && typeof item === 'object' && (item.type === 'section_title' || item.type === 'pullout_title')) {
            const tr = document.createElement('tr');
            tr.className = item.type === 'pullout_title' ? 'pullout-group-title-row' : 'issue-group-title-row';
            const td = document.createElement('td');
            td.colSpan = 6;
            td.textContent = item.text;
            tr.appendChild(td);
            table.appendChild(tr);
            return;
          }

          // Regular PDF rows
          if (item && item.file) {
            const abbreviatedFileName = getAbbreviatedFilename(item.file);
            const tr = document.createElement('tr');

            // File name
            const fileTd = document.createElement('td');
            fileTd.className = 'filename-col';
            fileTd.textContent = abbreviatedFileName;
            fileTd.title = item.file;

            // Title
            const titleTd = document.createElement('td');
            titleTd.className = 'title-col';
            titleTd.textContent = item.title || '';

            // Edit
            const editTd = document.createElement('td');
            editTd.className = 'edit-col';
            editTd.textContent = item.edit || '';

            // ICD
            const icdTd = document.createElement('td');
            icdTd.className = 'icd-col';
            icdTd.textContent = item.icd || '';

            // Status
            const statusTd = document.createElement('td');
            statusTd.className = 'status-col';
            const dot = document.createElement('span');
            dot.className = 'status-dot';
            dot.classList.add(item.ok ? 'status-ok' : 'status-fail');
            statusTd.appendChild(dot);

            // Time
            const timeTd = document.createElement('td');
            timeTd.className = 'time-col';
            timeTd.textContent = item.ok ? item.time : 'N/A';

            // Append all columns
            tr.appendChild(fileTd);
            tr.appendChild(titleTd);
            tr.appendChild(editTd);
            tr.appendChild(icdTd);
            tr.appendChild(statusTd);
            tr.appendChild(timeTd);
            table.appendChild(tr);
          }
        });

        card.appendChild(table);
        cardsContainer.appendChild(card);
      }
    }

    // Navigate to a specific date
// Navigate to a specific date
async function navigateToDate(index) {
    if (index < 0 || index >= availableDates.length) return;
    
    currentDateIndex = index;
    const datePrefix = availableDates[index];
    
    clearError();
    showLoading(`Loading data for ${formatDisplayDate(datePrefix)}...`);
    
    try {
        const snapshotData = await loadSnapshotForDate(datePrefix);
        hideLoading();
        renderStatusCards(snapshotData);
        
        // Update navigation buttons
        updateNavigationButtons();
    } catch (err) {
        hideLoading();
        showError(err.message);
    }
}

// Update navigation buttons state - CORRECTED BEHAVIOR
function updateNavigationButtons() {
    // Left arrow button (←) disabled when at the most recent date (last index)
    prevDateBtn.disabled = currentDateIndex >= availableDates.length - 1;
    // Right arrow button (→) disabled when at the oldest date (index 0)
    nextDateBtn.disabled = currentDateIndex <= 0;
}

// Event listeners for navigation - CORRECTED BEHAVIOR
prevDateBtn.addEventListener('click', () => {
    // Left arrow button (←) - go to previous (older) date
    if (currentDateIndex < availableDates.length - 1) {
        navigateToDate(currentDateIndex + 1);
    }
});

nextDateBtn.addEventListener('click', () => {
    // Right arrow button (→) - go to next (more recent) date
    if (currentDateIndex > 0) {
        navigateToDate(currentDateIndex - 1);
    }
});
    // Update navigation buttons state - SWAPPED BUTTONS
    function updateNavigationButtons() {
      // → Right arrow button disabled when at the most recent date (last index)
      prevDateBtn.disabled = currentDateIndex >= availableDates.length - 1;
      // ← Left arrow button disabled when at the oldest date (index 0)
      nextDateBtn.disabled = currentDateIndex <= 0;
    }

    // Find index of a date in available dates array
    function findDateIndex(datePrefix) {
      return availableDates.findIndex(date => date === datePrefix);
    }

    // Initialize the viewer
    async function initializeViewer() {
      try {
        showLoading('Loading default date...');
        
        // 1. Get default date from Settings sheet
        const defaultDate = await fetchDefaultDate();
        
        // 2. Get all available dates
        availableDates = await fetchAvailableDates();
        
        if (availableDates.length === 0) {
          hideLoading();
          showError('No saved snapshots found');
          return;
        }
        
        // 3. Find the default date in available dates, or use most recent
        let targetDateIndex = findDateIndex(defaultDate);
        if (targetDateIndex === -1) {
          // Default date not found, use most recent date
          targetDateIndex = 0;
        }
        
        // 4. Load the target date
        await navigateToDate(targetDateIndex);
        
      } catch (err) {
        hideLoading();
        showError('Failed to initialize: ' + err.message);
      }
    }

    // Event listeners for navigation - SWAPPED BUTTONS
    prevDateBtn.addEventListener('click', () => {
      // → Right arrow button - go to next (more recent) date
      if (currentDateIndex < availableDates.length - 1) {
        navigateToDate(currentDateIndex + 1);
      }
    });

    nextDateBtn.addEventListener('click', () => {
      // ← Left arrow button - go to previous (older) date
      if (currentDateIndex > 0) {
        navigateToDate(currentDateIndex - 1);
      }
    });

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initializeViewer);
  </script>
</body>
</html>