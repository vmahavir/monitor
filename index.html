<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CTP Page Monitor - Mobile Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --color-bg-primary: #0f0f12;
      --color-bg-secondary: #1a1a1f;
      --color-bg-card: #25252d;
      --color-text-light: #e0e0e0;
      --color-text-dim: #a0a0a0;
      --color-accent-blue: #0077b6;
      --color-accent-cyan: #00b4d8;
      --color-accent-yellow: #ffb703;
      --color-accent-red: #e63946;
      --color-accent-green: #3c9f3c;
      --color-issue-text: #66cc66;
      --color-edition-title-bg: #0077b6;
      --color-section-title-bg: #33333d;
      --color-status-ok: #1cc88a;
      --color-status-fail: #f6c23e;
      --color-status-wait: #e74a3b;
      --color-section-title: #f8f9fa;
      --color-border: #33333d;
      --color-central-desk-bg: #2d3a4d;
      --color-central-desk-title: #4a90e2;
      --border-radius: 3px;
      --spacing-unit: 6px;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--color-bg-primary);
      color: var(--color-text-light);
      padding: var(--spacing-unit);
      font-size: 0.833em;
      line-height: 1.3;
    }

    .header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--color-bg-secondary);
      padding: var(--spacing-unit);
      border-radius: var(--border-radius);
      margin-bottom: var(--spacing-unit);
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
    }
    
    .title {
      color: var(--color-accent-yellow);
      font-weight: normal;
      font-size: 1.3em;
    }
    
    .nav-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .nav-btn {
      background: var(--color-accent-blue);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.95em;
    }
    
    .nav-btn:disabled {
      background: var(--color-bg-card);
      color: var(--color-text-dim);
      cursor: not-allowed;
    }
    
    .current-date {
      font-weight: bold;
      color: var(--color-accent-yellow);
      min-width: 80px;
      text-align: center;
    }

    /* Tabs styling - more compact for mobile */
    .tabs-container {
      display: flex;
      overflow-x: auto;
      background: var(--color-bg-secondary);
      border-radius: var(--border-radius);
      margin-bottom: var(--spacing-unit);
      scrollbar-width: none;
      padding: 0 2px;
    }
    
    .tabs-container::-webkit-scrollbar {
      display: none;
    }
    
    .tab {
      flex: 1;
      min-width: 70px;
      padding: 6px 8px;
      text-align: center;
      background: var(--color-bg-secondary);
      color: var(--color-text-dim);
      border: none;
      cursor: pointer;
      font-size: 0.85em;
      white-space: nowrap;
      transition: all 0.2s;
      margin: 0 1px;
    }
    
    .tab.active {
      background: var(--color-accent-blue);
      color: white;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }

    .card {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      padding: 0;
      overflow: hidden;
      margin-bottom: var(--spacing-unit);
    }

    .card h3 {
      margin: 0;
      padding: 6px 8px;
      background: var(--color-edition-title-bg);
      color: white;
      font-weight: normal;
      font-size: 1.05em;
      text-transform: uppercase;
    }
    
    .card.central-desk h3 {
      background: var(--color-central-desk-title);
    }

    .checklist-table {
      width: 100%;
      font-size: 0.9em;
      border-collapse: collapse;
    }
    
    .checklist-table td {
      padding: 3px;
      border-bottom: 1px solid #2f2f38;
    }
    
    .checklist-table tr:last-child td { 
      border-bottom: none; 
    }

    /* Regular edition columns */
    .filename-col {
      width: 15%;
      white-space: nowrap;
    }
    
    .title-col {
      width: 40%;
    }
    
    .edit-col, .icd-col { 
      width: 10%; 
      text-align: center; 
    }
    
    .status-col { 
      width: 3%; 
      text-align: center; 
    }
    
    .time-col { 
      width: 22%; 
      text-align: right; 
      color: var(--color-text-dim);
      white-space: nowrap;
    }

    /* CD Pages specific columns */
    .pattern-col {
      width: 20%;
      white-space: nowrap;
    }
    
    .display-name-col {
      width: 45%;
    }
    
    .status-cd-col {
      width: 5%;
      text-align: center;
    }
    
    .time-cd-col {
      width: 30%;
      text-align: right;
      color: var(--color-text-dim);
      white-space: nowrap;
    }

    .issue-group-title-row td, .pullout-group-title-row td {
      padding: 4px 8px !important;
      font-weight: normal;
      font-size: 1em;
      color: var(--color-section-title);
      background: var(--color-section-title-bg);
      border-bottom: 1px solid var(--color-border) !important;
    }
    
    .pullout-group-title-row td {
      color: #c0c0ff;
      background: #3d3345;
    }
    
    .central-desk-group-title-row td {
      color: #c0e0ff;
      background: var(--color-central-desk-bg);
    }

    /* STATUS DOTS */
    .status-dot {
      display: inline-block;
      width: 7px;
      height: 7px;
      border-radius: 50%;
      vertical-align: middle;
    }
    
    .status-ok { 
      background-color: var(--color-status-ok);
    }
    
    .status-no { 
      background-color: var(--color-status-fail);
    }
    
    .status-wait { 
      background-color: var(--color-status-wait);
    }

    .error {
      background: #3d0000;
      color: #ffcccc;
      padding: 6px 8px;
      border-radius: 3px;
      border-left: 4px solid var(--color-accent-red);
      margin-bottom: 6px;
      font-size: 0.95em;
    }

    .warning {
      background: #3d3d00;
      color: #ffffcc;
      padding: 6px 8px;
      border-radius: 3px;
      border-left: 4px solid var(--color-accent-yellow);
      margin-bottom: 6px;
      font-size: 0.95em;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: var(--color-text-dim);
    }
    
    .progress-bar {
      width: 100%;
      height: 4px;
      background: var(--color-bg-secondary);
      border-radius: 2px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--color-accent-blue);
      transition: width 0.3s ease;
      width: 0%;
    }
  </style>
</head>
<body>
  <div class="header-bar">
    <div class="title">CTP Page Monitor</div>
    <div class="nav-controls">
      <button id="prev-date-btn" class="nav-btn" disabled>←</button>
      <div id="current-date" class="current-date">Loading...</div>
      <button id="next-date-btn" class="nav-btn" disabled>→</button>
    </div>
  </div>

  <div id="tabs-container" class="tabs-container">
    <!-- Tabs will be dynamically generated -->
  </div>

  <div id="errorContainer"></div>
  <div id="warningContainer"></div>
  <div id="loadingMessage" class="loading">
    <div>Loading data...</div>
    <div class="progress-bar">
      <div id="progressFill" class="progress-fill"></div>
    </div>
    <div id="progressText">0%</div>
  </div>
  
  <!-- Tab content containers -->
  <div id="tab-kokan" class="tab-content"></div>
  <div id="tab-satara" class="tab-content"></div>
  <div id="tab-sangli" class="tab-content"></div>
  <div id="tab-kolhapur" class="tab-content"></div>
  <div id="tab-pullout" class="tab-content"></div>
  <div id="tab-cd-pages" class="tab-content"></div>

  <script>
    // Configuration - Google Apps Script URL
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyV61JS7fzOX5C2Bs2bkszDWHxoZvo1-0oEDuJk81Iri2r5zo7ULK3uNM-PfkGD3RQ/exec";
    
    let availableDates = [];
    let currentDateIndex = -1;
    let currentDatePrefix = '';
    let syncIntervalId = null;
    let currentActiveTab = 'kokan';

    // DOM Elements
    const prevDateBtn = document.getElementById('prev-date-btn');
    const nextDateBtn = document.getElementById('next-date-btn');
    const currentDateEl = document.getElementById('current-date');
    const errorContainer = document.getElementById('errorContainer');
    const warningContainer = document.getElementById('warningContainer');
    const loadingMessage = document.getElementById('loadingMessage');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const tabsContainer = document.getElementById('tabs-container');

    // Update progress bar
    function updateProgress(percent, text) {
      progressFill.style.width = `${percent}%`;
      progressText.textContent = text || `${Math.round(percent)}%`;
    }

    // Format date for display
    function formatDisplayDate(dateStr) {
      if (!dateStr || dateStr.length !== 8) return 'N/A';
      return `${dateStr.substring(0, 2)}/${dateStr.substring(2, 4)}/${dateStr.substring(4, 8)}`;
    }

    // Show error message
    function showError(msg) {
      errorContainer.innerHTML = `<div class="error">${msg}</div>`;
      console.error(`ERROR: ${msg}`);
    }

    // Show warning message
    function showWarning(msg) {
      warningContainer.innerHTML = `<div class="warning">${msg}</div>`;
      console.warn(`WARNING: ${msg}`);
    }

    // Clear messages
    function clearMessages() {
      errorContainer.innerHTML = '';
      warningContainer.innerHTML = '';
    }

    // Show loading state
    function showLoading(message) {
      loadingMessage.style.display = 'block';
      loadingMessage.children[0].textContent = message;
      updateProgress(0, 'Starting...');
      hideAllTabContents();
    }

    // Hide loading state
    function hideLoading() {
      loadingMessage.style.display = 'none';
      updateProgress(0);
    }

    // Hide all tab contents
    function hideAllTabContents() {
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(tab => tab.classList.remove('active'));
    }

    // Clear all tab contents
    function clearAllTabContents() {
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(tab => {
        tab.innerHTML = '';
      });
    }

    // Initialize tabs
    function initializeTabs() {
      const tabs = [
        { id: 'kokan', label: 'Kokan' },
        { id: 'satara', label: 'Satara' },
        { id: 'sangli', label: 'Sangli' },
        { id: 'kolhapur', label: 'Kolhapur' },
        { id: 'pullout', label: 'Pullout' },
        { id: 'cd-pages', label: 'CD-Pages' }
      ];
      
      tabsContainer.innerHTML = '';
      
      tabs.forEach(tab => {
        const tabElement = document.createElement('button');
        tabElement.className = 'tab';
        tabElement.id = `tab-${tab.id}-btn`;
        tabElement.textContent = tab.label;
        tabElement.addEventListener('click', () => switchTab(tab.id));
        tabsContainer.appendChild(tabElement);
      });
      
      // Set Kokan as default active tab
      switchTab('kokan');
    }

    // Switch to a specific tab
    function switchTab(tabId) {
      // Deactivate all tabs
      const allTabs = document.querySelectorAll('.tab');
      allTabs.forEach(tab => tab.classList.remove('active'));
      
      // Hide all tab contents
      hideAllTabContents();
      
      // Activate selected tab
      const selectedTab = document.getElementById(`tab-${tabId}-btn`);
      if (selectedTab) {
        selectedTab.classList.add('active');
      }
      
      // Show selected tab content
      const selectedContent = document.getElementById(`tab-${tabId}`);
      if (selectedContent) {
        selectedContent.classList.add('active');
      }
      
      // Save active tab to localStorage
      currentActiveTab = tabId;
      localStorage.setItem('ctp-active-tab', tabId);
    }

    // Render status dot based on status value
    function renderStatusDot(status) {
      if (!status) status = "Wait";
      const s = status.toLowerCase();
      let cls = "status-wait";
      if (s === "ok") cls = "status-ok";
      else if (s === "no") cls = "status-no";
      return `<span class="status-dot ${cls}" title="${status}"></span>`;
    }

    // Enhanced fetch with timeout, retries, and better error handling
    async function safeFetch(url, options = {}, retries = 3) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
        
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response;
      } catch (error) {
        clearTimeout(timeoutId);
        
        if (retries > 0 && (error.name === 'AbortError' || error.message.includes('Failed to fetch'))) {
          await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second before retry
          return safeFetch(url, options, retries - 1);
        }
        
        if (error.name === 'AbortError') {
          throw new Error('Request timeout - server took too long to respond');
        }
        throw error;
      }
    }

    // Fetch available dates from Google Apps Script
    async function fetchAvailableDates() {
      try {
        const url = `${GAS_URL}?action=listDates&cacheBuster=${Date.now()}`;
        
        const res = await safeFetch(url);
        const json = await res.json();
        
        if (json.status === 'success' && Array.isArray(json.dates)) {
          return json.dates;
        } else {
          throw new Error(json.message || 'Invalid response format from server');
        }
      } catch (err) {
        throw new Error(`Failed to load dates: ${err.message}`);
      }
    }

    // Load data using GET SNAPSHOT
    async function loadSnapshotData(datePrefix) {
      try {
        const url = `${GAS_URL}?action=getSnapshot&date=${datePrefix}&cacheBuster=${Date.now()}`;
        
        updateProgress(20, 'Fetching snapshot data...');
        
        const res = await safeFetch(url);
        const json = await res.json();
        
        if (json.status === 'success') {
          // Process the combined data from page_log_json
          let combinedData = {};
          if (json.page_log_json) {
            try {
              combinedData = JSON.parse(json.page_log_json);
            } catch (parseError) {
              console.error('Failed to parse page_log_json:', parseError);
            }
          }
          
          // Process CD-Pages data from centraldesk_data (H column)
          let cdPagesData = {};
          if (json.centraldesk_data) {
            try {
              cdPagesData = JSON.parse(json.centraldesk_data);
            } catch (parseError) {
              console.error('Failed to parse centraldesk_data:', parseError);
            }
          }
          
          return {
            snapshot: {
              status: combinedData,
              cd_pages: cdPagesData,
              monitoring_date: datePrefix
            },
            datePrefix: datePrefix
          };
        } else if (json.status === 'not_found') {
          return {
            snapshot: {
              status: {},
              cd_pages: {},
              monitoring_date: datePrefix
            },
            datePrefix: datePrefix
          };
        } else {
          throw new Error(json.message || 'Invalid snapshot response');
        }
      } catch (err) {
        throw new Error(`Failed to load data: ${err.message}`);
      }
    }

    // Process unified status data into display structure
    function processUnifiedStatus(unifiedStatus, datePrefix) {
      const editionStructure = {
        '01Kokan': [],
        '02Satara': [],
        '03Sangli': [],
        '04Kolhapur': [],
        '05Pullout': [],
        '06CDPages': []
      };

      if (!unifiedStatus || !unifiedStatus.status || Object.keys(unifiedStatus.status).length === 0) {
        return editionStructure;
      }

      const statusData = unifiedStatus.status;
      
      updateProgress(60, 'Processing data...');

      // Group files by edition and issue type
      const filesByEditionAndIssue = {};

      for (const filename in statusData) {
        const fileData = statusData[filename];
        
        // Skip if no meaningful data
        if (!fileData) continue;

        // Determine edition from filename
        let edition = '';
        let issueType = 'Other Issue';
        let prefix = '';

        // Extract prefix from filename
        const parts = filename.split('-');
        if (parts.length >= 3) {
          prefix = parts[1] + '-' + parts[2];
        } else {
          prefix = filename.replace('.pdf', '');
        }

        // IDENTIFY PULLOUT FILES
        if (filename.includes('PUL-')) {
          edition = '05Pullout';
          
          // Determine specific pullout type
          if (filename.includes('KHK')) {
            issueType = 'Kolhapur-City Pullout';
          } else if (filename.includes('KHD')) {
            issueType = 'Kolhapur-District Pullout';
          } else if (filename.includes('RTH')) {
            issueType = 'Kokan-Ratnagiri Pullout';
          } else if (filename.includes('SDH')) {
            issueType = 'Kokan-Sindhudurg Pullout';
          } else if (filename.includes('SNH')) {
            issueType = 'Sangli Pullout';
          } else if (filename.includes('PHL')) {
            issueType = 'Satara-Phaltan Pullout';
          } else if (filename.includes('KRD')) {
            issueType = 'Satara-Karad Pullout';
          } else if (filename.includes('WKM')) {
            issueType = 'Satara-Wai Pullout';
          } else if (filename.includes('MNTH')) {
            issueType = 'Saransh Issue (Sunday)';
          } else {
            issueType = 'Pullout';
          }
        }
        // Regular edition files
        else if (filename.includes('RTN') || filename.includes('RTH') || filename.includes('SDH')) {
          edition = '01Kokan';
          if (filename.includes('LK-RTN')) issueType = 'Main Issue';
          else if (filename.includes('RTH')) issueType = 'Ratnagiri Hello';
          else if (filename.includes('SDH')) issueType = 'Sindhudurg Hello';
        } else if (filename.includes('SAT') || filename.includes('STH')) {
          edition = '02Satara';
          if (filename.includes('LK-SAT')) issueType = 'Main Issue';
          else if (filename.includes('STH')) issueType = 'Hello Issue';
        } else if (filename.includes('SNG') || filename.includes('SNH')) {
          edition = '03Sangli';
          if (filename.includes('LK-SNG')) issueType = 'Main Issue';
          else if (filename.includes('SNH')) issueType = 'Hello Issue';
        } else if (filename.includes('KOL') || filename.includes('KHK') || filename.includes('KHD')) {
          edition = '04Kolhapur';
          if (filename.includes('LK-KOL')) issueType = 'Main Issue';
          else if (filename.includes('KHK')) issueType = 'City Hello';
          else if (filename.includes('KHD')) issueType = 'District Hello (Rare)';
        } else {
          // Skip files that don't match any known pattern
          continue;
        }

        // Initialize edition and issue type in our structure
        if (!filesByEditionAndIssue[edition]) {
          filesByEditionAndIssue[edition] = {};
        }
        if (!filesByEditionAndIssue[edition][issueType]) {
          filesByEditionAndIssue[edition][issueType] = {
            prefix: prefix,
            files: []
          };
        }

        // Add file to the appropriate group
        filesByEditionAndIssue[edition][issueType].files.push({
          filename: filename,
          data: fileData
        });
      }

      // Build the edition structure with section titles
      for (const edition in filesByEditionAndIssue) {
        // Get all issue types for this edition and sort them
        const issueTypes = Object.keys(filesByEditionAndIssue[edition]);
        
        // Sort issue types
        issueTypes.sort((a, b) => {
          const order = {
            'Main Issue': 1,
            'Ratnagiri Hello': 2,
            'Sindhudurg Hello': 3,
            'Hello Issue': 4,
            'City Hello': 5,
            'District Hello (Rare)': 6,
            'Saransh Issue (Sunday)': 7,
            'Kolhapur-City Pullout': 8,
            'Kolhapur-District Pullout': 9,
            'Kokan-Ratnagiri Pullout': 10,
            'Kokan-Sindhudurg Pullout': 11,
            'Sangli Pullout': 12,
            'Satara-Phaltan Pullout': 13,
            'Satara-Karad Pullout': 14,
            'Satara-Wai Pullout': 15,
            'Pullout': 16,
            'Other Issue': 99
          };
          return (order[a] || 100) - (order[b] || 100);
        });

        // Add issues in sorted order
        for (const issueType of issueTypes) {
          const issueData = filesByEditionAndIssue[edition][issueType];
          const pageCount = issueData.files.length;
          
          // Add section title
          const isPullout = edition === '05Pullout';
          
          let rowType = 'section_title';
          if (isPullout) rowType = 'pullout_title';
          
          editionStructure[edition].push({
            type: rowType,
            text: `${issueType} (${pageCount} Pages) - ${issueData.prefix}`
          });

          // Sort files by page number
          issueData.files.sort((a, b) => {
            const pageNumA = parseInt(a.filename.match(/-(\d+)\.pdf$/)?.[1] || '0');
            const pageNumB = parseInt(b.filename.match(/-(\d+)\.pdf$/)?.[1] || '0');
            return pageNumA - pageNumB;
          });

          // Add files in page order
          issueData.files.forEach(fileInfo => {
            editionStructure[edition].push({
              file: fileInfo.filename,
              title: fileInfo.data.title || '',
              edit: fileInfo.data.edit || '',
              icd: fileInfo.data.icd || '',
              ok: fileInfo.data.ok || "Wait",
              time: fileInfo.data.time || 'N/A'
            });
          });
        }
      }

      // Add CD-Pages data from H column
      if (unifiedStatus.cd_pages && typeof unifiedStatus.cd_pages === 'object') {
        Object.entries(unifiedStatus.cd_pages).forEach(([pattern, data]) => {
          editionStructure['06CDPages'].push({
            type: 'cd_page_item',
            pattern: pattern,
            displayName: data.display_name || pattern,
            ok: data.ok || "Wait",
            time: data.time || 'N/A'
          });
        });
      }

      // Remove empty editions (except CD-Pages which should always show)
      Object.keys(editionStructure).forEach(edition => {
        if (edition !== '06CDPages' && editionStructure[edition].length === 0) {
          delete editionStructure[edition];
        }
      });

      updateProgress(80, 'Rendering display...');
      return editionStructure;
    }

    // Render status cards from processed data
    function renderStatusCards(snapshotData) {
      clearAllTabContents();
      
      if (!snapshotData || !snapshotData.snapshot) {
        const errorMsg = 'No data available for this date';
        document.getElementById('tab-kokan').innerHTML = `<div class="warning">${errorMsg}</div>`;
        document.getElementById('tab-kokan').classList.add('active');
        return;
      }

      const { snapshot, datePrefix } = snapshotData;

      // Update current date display with the date from column A
      currentDatePrefix = datePrefix;
      currentDateEl.textContent = formatDisplayDate(datePrefix);

      // Process the unified status structure
      const editionStructure = processUnifiedStatus(snapshot, datePrefix);

      // Helper function to convert the full filename to abbreviated version
      function getAbbreviatedFilename(fullFileName) {
        const parts = fullFileName.split('-');
        
        // For pullout files, show specific abbreviations
        if (fullFileName.includes('PUL-')) {
          if (parts.length >= 4) {
            const pulloutCode = parts[2];
            const pageNum = parts[3].replace('.pdf', '');
            return `P-${pulloutCode}-${pageNum}`;
          }
        }
        
        // For regular files
        if (parts.length >= 3) {
          let suffix = parts.slice(-2).join('-');
          if (suffix.endsWith('.pdf')) suffix = suffix.slice(0, -4);
          return suffix;
        }
        
        return fullFileName;
      }

      // Check if we have data and update tab visibility
      const hasPulloutData = editionStructure.hasOwnProperty('05Pullout') && editionStructure['05Pullout'].length > 0;
      
      const pulloutTab = document.getElementById('tab-pullout-btn');
      
      if (pulloutTab) {
        pulloutTab.style.display = hasPulloutData ? 'flex' : 'none';
      }
      
      // CD-Pages tab is always visible

      // Render each edition to its respective tab
      const tabMapping = {
        '01Kokan': 'kokan',
        '02Satara': 'satara', 
        '03Sangli': 'sangli',
        '04Kolhapur': 'kolhapur',
        '05Pullout': 'pullout',
        '06CDPages': 'cd-pages'
      };

      let totalCards = 0;
      for (const editionKey in editionStructure) {
        const tabId = tabMapping[editionKey];
        if (!tabId) continue;
        
        const tabContent = document.getElementById(`tab-${tabId}`);
        if (!tabContent) continue;
        
        const rows = editionStructure[editionKey];
        
        // Create card for this edition
        const card = document.createElement('div');
        card.className = editionKey === '06CDPages' ? 'card central-desk' : 'card';

        const title = document.createElement('h3');
        title.textContent = editionKey.replace('01', '').replace('02', '').replace('03', '').replace('04', '').replace('05', '').replace('06CDPages', 'CD Pages');
        card.appendChild(title);

        const table = document.createElement('table');
        table.className = 'checklist-table';

        // Special handling for CD-Pages (4 columns)
        if (editionKey === '06CDPages') {
          rows.forEach(item => {
            if (item.type === 'cd_page_item') {
              const tr = document.createElement('tr');

              // Pattern
              const patternTd = document.createElement('td');
              patternTd.className = 'pattern-col';
              patternTd.textContent = item.pattern || '';

              // Display Name
              const displayNameTd = document.createElement('td');
              displayNameTd.className = 'display-name-col';
              displayNameTd.textContent = item.displayName || '';

              // Status
              const statusTd = document.createElement('td');
              statusTd.className = 'status-cd-col';
              statusTd.innerHTML = renderStatusDot(item.ok);

              // Time
              const timeTd = document.createElement('td');
              timeTd.className = 'time-cd-col';
              timeTd.textContent = item.ok === "OK" ? (item.time || 'N/A') : 'N/A';

              // Append all columns
              tr.appendChild(patternTd);
              tr.appendChild(displayNameTd);
              tr.appendChild(statusTd);
              tr.appendChild(timeTd);
              table.appendChild(tr);
            }
          });
        } else {
          // Regular edition files (6 columns)
          rows.forEach(item => {
            // Group titles
            if (item && typeof item === 'object' && (item.type === 'section_title' || item.type === 'pullout_title')) {
              const tr = document.createElement('tr');
              tr.className = item.type;
              const td = document.createElement('td');
              td.colSpan = 6;
              td.textContent = item.text;
              tr.appendChild(td);
              table.appendChild(tr);
              return;
            }

            // Regular PDF rows
            if (item && item.file) {
              const abbreviatedFileName = getAbbreviatedFilename(item.file);
              const tr = document.createElement('tr');

              // File name
              const fileTd = document.createElement('td');
              fileTd.className = 'filename-col';
              fileTd.textContent = abbreviatedFileName;
              fileTd.title = item.file;

              // Title
              const titleTd = document.createElement('td');
              titleTd.className = 'title-col';
              titleTd.textContent = item.title || '';

              // Edit
              const editTd = document.createElement('td');
              editTd.className = 'edit-col';
              editTd.textContent = item.edit || '';

              // ICD
              const icdTd = document.createElement('td');
              icdTd.className = 'icd-col';
              icdTd.textContent = item.icd || '';

              // Status
              const statusTd = document.createElement('td');
              statusTd.className = 'status-col';
              statusTd.innerHTML = renderStatusDot(item.ok);

              // Time
              const timeTd = document.createElement('td');
              timeTd.className = 'time-col';
              timeTd.textContent = item.ok === "OK" ? (item.time || 'N/A') : 'N/A';

              // Append all columns
              tr.appendChild(fileTd);
              tr.appendChild(titleTd);
              tr.appendChild(editTd);
              tr.appendChild(icdTd);
              tr.appendChild(statusTd);
              tr.appendChild(timeTd);
              table.appendChild(tr);
            }
          });
        }

        card.appendChild(table);
        tabContent.appendChild(card);
        totalCards++;
      }

      updateProgress(100, 'Complete!');

      // Activate Kokan tab by default
      switchTab('kokan');
    }

    // Navigate to a specific date
    async function navigateToDate(index) {
      if (index < 0 || index >= availableDates.length) return;
      
      currentDateIndex = index;
      const datePrefix = availableDates[index];
      
      clearMessages();
      showLoading(`Loading data for ${formatDisplayDate(datePrefix)}...`);
      
      try {
        // Use single snapshot API call instead of multiple edition calls
        const snapshotData = await loadSnapshotData(datePrefix);
        hideLoading();
        renderStatusCards(snapshotData);
        
        // Update navigation buttons
        updateNavigationButtons();
        
      } catch (err) {
        hideLoading();
        showError(err.message);
      }
    }

    // Update navigation buttons state
    function updateNavigationButtons() {
      prevDateBtn.disabled = currentDateIndex >= availableDates.length - 1;
      nextDateBtn.disabled = currentDateIndex <= 0;
    }

    // Start automatic synchronization
    function startAutoSync() {
      if (syncIntervalId) clearInterval(syncIntervalId);
      
      syncIntervalId = setInterval(async () => {
        if (currentDateIndex >= 0 && currentDateIndex < availableDates.length) {
          try {
            const datePrefix = availableDates[currentDateIndex];
            const snapshotData = await loadSnapshotData(datePrefix);
            renderStatusCards(snapshotData);
          } catch (err) {
            console.error('Auto-sync failed:', err.message);
          }
        }
      }, 30000);
    }

    // Initialize the application
    async function initialize() {
      try {
        showLoading('Initializing application...');
        
        // Initialize tabs first
        initializeTabs();
        
        updateProgress(10, 'Loading dates...');
        availableDates = await fetchAvailableDates();
        
        if (availableDates.length === 0) {
          throw new Error('No dates found in the database');
        }
        
        // Set current date to the most recent (first in array after sort)
        currentDateIndex = availableDates.length - 1;
        
        // Navigate to current date
        await navigateToDate(currentDateIndex);
        
        // Start auto-sync
        startAutoSync();
        
      } catch (err) {
        hideLoading();
        showError(err.message);
        
        // Show additional help for common issues
        if (err.message.includes('Failed to fetch') || err.message.includes('timeout')) {
          showWarning(`
            Connection issue detected. Please check:
            1. Your internet connection
            2. The Google Apps Script URL is correct and deployed as web app
            3. The script has proper permissions (Execute as: Me, Access: Anyone)
          `);
        }
      }
    }

    // Event listeners
    prevDateBtn.addEventListener('click', () => {
      if (currentDateIndex < availableDates.length - 1) {
        navigateToDate(currentDateIndex + 1);
      }
    });

    nextDateBtn.addEventListener('click', () => {
      if (currentDateIndex > 0) {
        navigateToDate(currentDateIndex - 1);
      }
    });

    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>