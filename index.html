<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CTP Page Monitor - Mobile Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* --- CSS Variables for Compact Dark Theme --- */
    :root {
      --color-bg-primary: #0f0f12;
      --color-bg-secondary: #1a1a1f;
      --color-bg-card: #25252d;
      --color-text-light: #e0e0e0;
      --color-text-dim: #a0a0a0;
      --color-accent-blue: #0077b6;
      --color-accent-cyan: #00b4d8;
      --color-accent-yellow: #ffb703;
      --color-accent-red: #e63946;
      --color-accent-green: #3c9f3c;
      --color-issue-text: #66cc66;
      --color-edition-title-bg: #0077b6;
      --color-section-title-bg: #33333d;
      --color-status-ok: #2a9d8f;
      --color-status-fail: #e76f51;
      --color-section-title: #f8f9fa;
      --color-border: #33333d;
      --border-radius: 3px;
      --spacing-unit: 6px;
    }

    /* --- Base Styles --- */
    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--color-bg-primary);
      color: var(--color-text-light);
      padding: var(--spacing-unit);
      font-size: 0.833em;
      line-height: 1.3;
    }

    /* --- Header & Navigation --- */
    .header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--color-bg-secondary);
      padding: var(--spacing-unit);
      border-radius: var(--border-radius);
      margin-bottom: var(--spacing-unit);
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
    }
    
    .title {
      color: var(--color-accent-yellow);
      font-weight: normal;
      font-size: 1.3em;
    }
    
    .nav-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .nav-btn {
      background: var(--color-accent-blue);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.95em;
    }
    
    .nav-btn:disabled {
      background: var(--color-bg-card);
      color: var(--color-text-dim);
      cursor: not-allowed;
    }
    
    .current-date {
      font-weight: bold;
      color: var(--color-accent-yellow);
      min-width: 80px;
      text-align: center;
    }

    /* --- Status Cards Layout --- */
    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--spacing-unit);
    }

    .card {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      padding: 0;
      overflow: hidden;
    }

    .card h3 {
      margin: 0;
      padding: 6px 8px;
      background: var(--color-edition-title-bg);
      color: white;
      font-weight: normal;
      font-size: 1.05em;
      text-transform: uppercase;
    }

    .checklist-table {
      width: 100%;
      font-size: 0.9em;
      border-collapse: collapse;
    }
    
    .checklist-table td {
      padding: 3px;
      border-bottom: 1px solid #2f2f38;
    }
    
    .checklist-table tr:last-child td { 
      border-bottom: none; 
    }

    /* Column widths */
    .filename-col {
      width: 15%;
      white-space: nowrap;
    }
    
    .title-col {
      width: 43%;
    }
    
    .edit-col, .icd-col { 
      width: 7%; 
      text-align: center; 
    }
    
    .status-col { 
      width: 3%; 
      text-align: center; 
    }
    
    .time-col { 
      width: 25%; 
      text-align: right; 
      color: var(--color-text-dim); 
    }

    .issue-group-title-row td, .pullout-group-title-row td {
      padding: 4px 8px !important;
      font-weight: normal;
      font-size: 1em;
      color: var(--color-section-title);
      background: var(--color-section-title-bg);
      border-bottom: 1px solid var(--color-border) !important;
      column-span: 6;
    }
    
    .pullout-group-title-row td {
      color: #c0c0ff;
      background: #3d3345;
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .status-ok { 
      background-color: var(--color-status-ok); 
    }
    
    .status-fail { 
      background-color: var(--color-status-fail); 
    }

    .error {
      background: #3d0000;
      color: #ffcccc;
      padding: 6px 8px;
      border-radius: 3px;
      border-left: 4px solid var(--color-accent-red);
      margin-bottom: 6px;
      font-size: 0.95em;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: var(--color-text-dim);
    }

    .config-section {
      background: var(--color-bg-secondary);
      padding: 10px;
      border-radius: var(--border-radius);
      margin-bottom: 10px;
    }
    
    .config-input {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      color: var(--color-text-light);
      padding: 6px 8px;
      border-radius: var(--border-radius);
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 8px;
    }
    
    .config-btn {
      background: var(--color-accent-blue);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      padding: 8px 12px;
      cursor: pointer;
      width: 100%;
    }
  </style>
</head>
<body>
  <div class="header-bar">
    <div class="title">CTP Page Monitor</div>
    <div class="nav-controls">
      <button id="prev-date-btn" class="nav-btn" disabled>←</button>
      <div id="current-date" class="current-date">-</div>
      <button id="next-date-btn" class="nav-btn" disabled>→</button>
    </div>
  </div>

  <div id="configSection" class="config-section">
    <h3 style="margin-top: 0; color: var(--color-accent-yellow);">Google Apps Script URL</h3>
    <input type="text" id="gas-url" class="config-input" 
           placeholder="https://script.google.com/macros/s/..." 
           value="https://script.google.com/macros/s/AKfycbzQ8-Wgdg44ogQfKAoZSEoDQMaXRc7KT6EG4x1UFRk5RhcHp-ergUwtIQEnrUREItgV/exec">
    <button id="connect-btn" class="config-btn">Connect & Load Dates</button>
  </div>

  <div id="errorContainer"></div>
  <div id="loadingMessage" class="loading" style="display: none;">Loading available dates...</div>
  <div class="container" id="cards"></div>

  <script>
    // Configuration
    let GAS_URL = "https://script.google.com/macros/s/AKfycbzQ8-Wgdg44ogQfKAoZSEoDQMaXRc7KT6EG4x1UFRk5RhcHp-ergUwtIQEnrUREItgV/exec";
    let availableDates = [];
    let currentDateIndex = -1;

    // DOM Elements
    const gasUrlInput = document.getElementById('gas-url');
    const connectBtn = document.getElementById('connect-btn');
    const prevDateBtn = document.getElementById('prev-date-btn');
    const nextDateBtn = document.getElementById('next-date-btn');
    const currentDateEl = document.getElementById('current-date');
    const errorContainer = document.getElementById('errorContainer');
    const loadingMessage = document.getElementById('loadingMessage');
    const cardsContainer = document.getElementById('cards');

    // Format date for display
    function formatDisplayDate(dateStr) {
      if (!dateStr || dateStr.length !== 8) return 'N/A';
      return `${dateStr.substring(0, 2)}/${dateStr.substring(2, 4)}/${dateStr.substring(4, 8)}`;
    }

    // Show error message
    function showError(msg) {
      errorContainer.innerHTML = `<div class="error">${msg}</div>`;
      console.warn(msg);
    }

    // Clear error message
    function clearError() {
      errorContainer.innerHTML = '';
    }

    // Show loading state
    function showLoading(message) {
      loadingMessage.textContent = message;
      loadingMessage.style.display = 'block';
      cardsContainer.innerHTML = '';
    }

    // Hide loading state
    function hideLoading() {
      loadingMessage.style.display = 'none';
    }

    // Fetch available dates from Google Apps Script
    async function fetchAvailableDates() {
      try {
        const url = `${GAS_URL}?action=listDates`;
        console.log('Fetching dates from:', url);
        
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        
        const json = await res.json();
        console.log('Dates response:', json);
        
        if (json.status === 'success' && Array.isArray(json.dates)) {
          return json.dates;
        } else {
          throw new Error(json.message || 'Invalid response format');
        }
      } catch (err) {
        console.error('Failed to fetch dates:', err);
        throw new Error(`Failed to load dates: ${err.message}`);
      }
    }

    // Load snapshot data for a specific date
    async function loadSnapshotForDate(datePrefix) {
      try {
        const url = `${GAS_URL}?action=getSnapshot&date=${datePrefix}`;
        console.log('Fetching snapshot from:', url);
        
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        
        const json = await res.json();
        console.log('Snapshot response:', json);
        
        if (json.status === 'success' && json.page_log_json) {
          return JSON.parse(json.page_log_json);
        } else if (json.status === 'not_found') {
          throw new Error('No snapshot found for this date');
        } else {
          throw new Error(json.message || 'Invalid snapshot data');
        }
      } catch (err) {
        console.error('Failed to load snapshot:', err);
        throw new Error(`Failed to load snapshot: ${err.message}`);
      }
    }

    // Render status cards from snapshot data
    function renderStatusCards(snapshot) {
      cardsContainer.innerHTML = '';

      if (!snapshot || !snapshot.status) {
        cardsContainer.innerHTML = '<div class="error">No data available for this date</div>';
        return;
      }

      // Update current date display
      currentDateEl.textContent = formatDisplayDate(snapshot.monitoring_date);

      // Helper function to convert the full filename to abbreviated version
      function getAbbreviatedFilename(fullFileName) {
        const parts = fullFileName.split('-');
        if (parts.length >= 2) {
          let suffix = parts.slice(-2).join('-');
          if (suffix.endsWith('.pdf')) suffix = suffix.slice(0, -4);
          return suffix;
        }
        return fullFileName;
      }

      // Render each edition
      for (const editionKey in snapshot.status) {
        const card = document.createElement('div');
        card.className = 'card';

        const title = document.createElement('h3');
        title.textContent = editionKey;
        card.appendChild(title);

        const table = document.createElement('table');
        table.className = 'checklist-table';
        const rows = snapshot.status[editionKey];

        rows.forEach(item => {
          // Group titles (e.g., "Main Issue", "Pullout")
          if (item && typeof item === 'object' && (item.type === 'section_title' || item.type === 'pullout_title')) {
            const tr = document.createElement('tr');
            tr.className = item.type === 'pullout_title' ? 'pullout-group-title-row' : 'issue-group-title-row';
            const td = document.createElement('td');
            td.colSpan = 6;
            td.textContent = item.text;
            tr.appendChild(td);
            table.appendChild(tr);
            return;
          }

          // Regular PDF rows
          if (item && item.file) {
            const abbreviatedFileName = getAbbreviatedFilename(item.file);
            const tr = document.createElement('tr');

            // File name
            const fileTd = document.createElement('td');
            fileTd.className = 'filename-col';
            fileTd.textContent = abbreviatedFileName;
            fileTd.title = item.file;

            // Title
            const titleTd = document.createElement('td');
            titleTd.className = 'title-col';
            titleTd.textContent = item.title || '';

            // Edit
            const editTd = document.createElement('td');
            editTd.className = 'edit-col';
            editTd.textContent = item.edit || '';

            // ICD
            const icdTd = document.createElement('td');
            icdTd.className = 'icd-col';
            icdTd.textContent = item.icd || '';

            // Status
            const statusTd = document.createElement('td');
            statusTd.className = 'status-col';
            const dot = document.createElement('span');
            dot.className = 'status-dot';
            dot.classList.add(item.ok ? 'status-ok' : 'status-fail');
            statusTd.appendChild(dot);

            // Time
            const timeTd = document.createElement('td');
            timeTd.className = 'time-col';
            timeTd.textContent = item.ok ? item.time : 'N/A';

            // Append all columns
            tr.appendChild(fileTd);
            tr.appendChild(titleTd);
            tr.appendChild(editTd);
            tr.appendChild(icdTd);
            tr.appendChild(statusTd);
            tr.appendChild(timeTd);
            table.appendChild(tr);
          }
        });

        card.appendChild(table);
        cardsContainer.appendChild(card);
      }
    }

    // Navigate to a specific date
    async function navigateToDate(index) {
      if (index < 0 || index >= availableDates.length) return;
      
      currentDateIndex = index;
      const datePrefix = availableDates[index];
      
      clearError();
      showLoading(`Loading data for ${formatDisplayDate(datePrefix)}...`);
      
      try {
        const snapshot = await loadSnapshotForDate(datePrefix);
        hideLoading();
        renderStatusCards(snapshot);
      } catch (err) {
        hideLoading();
        showError(err.message);
      }
      
      // Update navigation buttons
      prevDateBtn.disabled = currentDateIndex <= 0;
      nextDateBtn.disabled = currentDateIndex >= availableDates.length - 1;
    }

    // Connect to GAS and load dates
    async function connectToGAS() {
      GAS_URL = gasUrlInput.value.trim();
      
      if (!GAS_URL) {
        showError('Please enter a valid Google Apps Script URL');
        return;
      }
      
      try {
        showLoading('Connecting to Google Apps Script...');
        clearError();
        
        availableDates = await fetchAvailableDates();
        hideLoading();
        
        if (availableDates.length === 0) {
          showError('No saved snapshots found');
          return;
        }
        
        // Start with the most recent date
        currentDateIndex = 0;
        await navigateToDate(currentDateIndex);
        
        // Hide config section after successful connection
        document.getElementById('configSection').style.display = 'none';
        
      } catch (err) {
        hideLoading();
        showError(err.message);
      }
    }

    // Event listeners
    connectBtn.addEventListener('click', connectToGAS);
    
    gasUrlInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        connectToGAS();
      }
    });

    prevDateBtn.addEventListener('click', () => {
      if (currentDateIndex > 0) {
        navigateToDate(currentDateIndex - 1);
      }
    });

    nextDateBtn.addEventListener('click', () => {
      if (currentDateIndex < availableDates.length - 1) {
        navigateToDate(currentDateIndex + 1);
      }
    });

    // Load GAS URL from localStorage if available
    window.addEventListener('DOMContentLoaded', () => {
      const savedUrl = localStorage.getItem('ctp_gas_url');
      if (savedUrl) {
        gasUrlInput.value = savedUrl;
      }
    });

    // Save GAS URL to localStorage when changed
    gasUrlInput.addEventListener('change', () => {
      localStorage.setItem('ctp_gas_url', gasUrlInput.value);
    });
  </script>
</body>
</html> 